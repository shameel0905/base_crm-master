/**
 * SHOPIFY VARIABLE PRODUCT TEST - COMPLETE REFERENCE
 * ===================================================
 * 
 * Based on "The Complete Snowboard" product analysis
 * Product ID: 7571308511415
 * 
 * IMPORTANT: How Shopify Variable Products Work
 * ==============================================
 * 
 * 1. OPTIONS are AUTO-GENERATED by Shopify from variant option values
 *    - You do NOT send options in the create product request
 *    - Shopify will automatically create options based on option1, option2, option3 values
 *    
 * 2. VARIANTS are what define the product structure
 *    Each variant must have:
 *    - price (required)
 *    - sku (optional but recommended)
 *    - inventory_quantity (optional)
 *    - option1, option2, option3 (optional, for defining variant combinations)
 * 
 * 3. VARIANT STRUCTURE
 *    Shopify creates options automatically:
 *    - If all variants have different "option1" values â†’ creates 1 option
 *    - If variants have "option1" and "option2" â†’ creates 2 options
 *    - Maximum 3 options supported
 */

const axios = require('axios');
require('dotenv').config();

const API_BASE_URL = 'http://localhost:3001/api/shopify';

/**
 * TEST 1: Single Option Product (like The Complete Snowboard)
 * ============================================================
 */
async function testSingleOptionProduct() {
  console.log('\n' + '='.repeat(80));
  console.log('TEST 1: Single-Option Variable Product');
  console.log('Example: The Complete Snowboard (5 colors)');
  console.log('='.repeat(80) + '\n');

  try {
    const productData = {
      title: 'The Complete Snowboard - Test',
      description: '<p>This <b>PREMIUM</b> <i>snowboard</i> is awesome!</p><p>This is variant product</p>',
      vendor: 'Snowboard Vendor',
      type: 'snowboard',
      slug: 'complete-snowboard-test',
      price: '699.95',
      // DO NOT send options - Shopify generates them automatically!
      variants: [
        { sku: '', price: '699.95', inventory_quantity: 10, option1: 'Ice' },
        { sku: '', price: '699.95', inventory_quantity: 10, option1: 'Dawn' },
        { sku: '', price: '699.95', inventory_quantity: 10, option1: 'Powder' },
        { sku: '', price: '699.95', inventory_quantity: 10, option1: 'Electric' },
        { sku: '', price: '699.95', inventory_quantity: 10, option1: 'Sunset' },
      ],
      images: ['https://cdn.shopify.com/s/files/1/0640/0019/6791/files/Main_589fc064-24a2-4236-9eaf-13b2bd35d21d.jpg'],
    };

    console.log('Request Payload:');
    console.log(JSON.stringify(productData, null, 2));

    const response = await axios.post(`${API_BASE_URL}/products`, productData);

    console.log('\nâœ… SUCCESS!\n');
    const product = response.data.data;
    
    console.log(`Product ID: ${product.id}`);
    console.log(`Title: ${product.title}`);
    console.log(`Variants: ${product.variants.length}`);
    console.log(`Options: ${product.options?.length || 0}`);

    if (product.options) {
      console.log('\nðŸ“ Auto-Generated Options:');
      product.options.forEach(opt => {
        console.log(`  - ${opt.name}: ${opt.values.join(', ')}`);
      });
    }

    console.log('\nðŸ”„ Variants:');
    product.variants.forEach((v, i) => {
      console.log(`  [${i+1}] Price: $${v.price}, Option1: ${v.option1}, Stock: ${v.inventory_quantity}, SKU: ${v.sku}`);
    });

    return product;
  } catch (error) {
    console.error('\nâŒ ERROR:', error.response?.data?.error || error.message);
    if (error.response?.data?.error?.includes('422')) {
      console.error('\nHint: 422 means unprocessable entity. Check your variant structure.');
    }
    throw error;
  }
}

/**
 * TEST 2: Two-Option Product (Size Ã— Color)
 * ==========================================
 */
async function testTwoOptionProduct() {
  console.log('\n' + '='.repeat(80));
  console.log('TEST 2: Two-Option Variable Product');
  console.log('Example: T-Shirt (3 Sizes Ã— 2 Colors = 6 variants)');
  console.log('='.repeat(80) + '\n');

  try {
    const productData = {
      title: 'Premium T-Shirt - Size & Color',
      description: 'Available in multiple sizes and colors',
      vendor: 'Fashion Co.',
      type: 'Apparel',
      slug: 'premium-tshirt-variants',
      price: '29.99',
      // Variant combinations: Small/Medium/Large Ã— Black/White
      variants: [
        { sku: 'TS-S-BLK', price: '29.99', inventory_quantity: 20, option1: 'Small', option2: 'Black' },
        { sku: 'TS-S-WHT', price: '29.99', inventory_quantity: 25, option1: 'Small', option2: 'White' },
        { sku: 'TS-M-BLK', price: '29.99', inventory_quantity: 30, option1: 'Medium', option2: 'Black' },
        { sku: 'TS-M-WHT', price: '29.99', inventory_quantity: 35, option1: 'Medium', option2: 'White' },
        { sku: 'TS-L-BLK', price: '29.99', inventory_quantity: 25, option1: 'Large', option2: 'Black' },
        { sku: 'TS-L-WHT', price: '29.99', inventory_quantity: 30, option1: 'Large', option2: 'White' },
      ],
    };

    console.log('Request Payload:');
    console.log(`- 6 variants (3 sizes Ã— 2 colors)`);
    console.log(`- Will auto-generate 2 options: Size (Small/Medium/Large) and Color (Black/White)`);

    const response = await axios.post(`${API_BASE_URL}/products`, productData);

    console.log('\nâœ… SUCCESS!\n');
    const product = response.data.data;
    
    console.log(`Product ID: ${product.id}`);
    console.log(`Title: ${product.title}`);
    console.log(`Variants: ${product.variants.length}`);
    console.log(`Options: ${product.options?.length || 0}`);

    if (product.options) {
      console.log('\nðŸ“ Auto-Generated Options:');
      product.options.forEach(opt => {
        console.log(`  - ${opt.name}: ${opt.values.join(', ')}`);
      });
    }

    console.log('\nðŸ“Š Variant Matrix:');
    console.log('         Black        White');
    ['Small', 'Medium', 'Large'].forEach(size => {
      const variants = product.variants.filter(v => v.option1 === size);
      let row = `${size.padEnd(9)}`;
      variants.forEach(v => {
        row += ` $${v.price}(${v.inventory_quantity}) `;
      });
      console.log(row);
    });

    return product;
  } catch (error) {
    console.error('\nâŒ ERROR:', error.response?.data?.error || error.message);
    throw error;
  }
}

/**
 * TEST 3: Three-Option Product (Size Ã— Color Ã— Material)
 * ======================================================
 */
async function testThreeOptionProduct() {
  console.log('\n' + '='.repeat(80));
  console.log('TEST 3: Three-Option Variable Product');
  console.log('Example: Jacket (2 Sizes Ã— 2 Colors Ã— 2 Materials = 8 variants)');
  console.log('='.repeat(80) + '\n');

  try {
    const productData = {
      title: 'Premium Jacket - Full Customization',
      description: 'Choose your size, color, and material',
      vendor: 'Fashion Co.',
      type: 'Apparel',
      slug: 'premium-jacket-custom',
      price: '99.99',
      variants: [
        { sku: 'JK-S-BLK-CTN', price: '89.99', inventory_quantity: 10, option1: 'Small', option2: 'Black', option3: 'Cotton' },
        { sku: 'JK-S-BLK-WOL', price: '129.99', inventory_quantity: 5, option1: 'Small', option2: 'Black', option3: 'Wool' },
        { sku: 'JK-S-RED-CTN', price: '89.99', inventory_quantity: 8, option1: 'Small', option2: 'Red', option3: 'Cotton' },
        { sku: 'JK-S-RED-WOL', price: '129.99', inventory_quantity: 3, option1: 'Small', option2: 'Red', option3: 'Wool' },
        { sku: 'JK-L-BLK-CTN', price: '89.99', inventory_quantity: 15, option1: 'Large', option2: 'Black', option3: 'Cotton' },
        { sku: 'JK-L-BLK-WOL', price: '129.99', inventory_quantity: 8, option1: 'Large', option2: 'Black', option3: 'Wool' },
        { sku: 'JK-L-RED-CTN', price: '89.99', inventory_quantity: 12, option1: 'Large', option2: 'Red', option3: 'Cotton' },
        { sku: 'JK-L-RED-WOL', price: '129.99', inventory_quantity: 6, option1: 'Large', option2: 'Red', option3: 'Wool' },
      ],
    };

    console.log('Request Payload:');
    console.log(`- 8 variants (2 sizes Ã— 2 colors Ã— 2 materials)`);
    console.log(`- Will auto-generate 3 options: Size, Color, Material`);

    const response = await axios.post(`${API_BASE_URL}/products`, productData);

    console.log('\nâœ… SUCCESS!\n');
    const product = response.data.data;
    
    console.log(`Product ID: ${product.id}`);
    console.log(`Title: ${product.title}`);
    console.log(`Variants: ${product.variants.length}`);
    console.log(`Options: ${product.options?.length || 0}`);

    if (product.options) {
      console.log('\nðŸ“ Auto-Generated Options:');
      product.options.forEach(opt => {
        console.log(`  - ${opt.name}: ${opt.values.join(', ')}`);
      });
    }

    return product;
  } catch (error) {
    console.error('\nâŒ ERROR:', error.response?.data?.error || error.message);
    throw error;
  }
}

/**
 * Run all tests
 */
async function runAllTests() {
  console.log('\nâ•”' + 'â•'.repeat(78) + 'â•—');
  console.log('â•‘ SHOPIFY VARIABLE PRODUCT TEST - COMPLETE REFERENCE                        â•‘');
  console.log('â•‘ Based on "The Complete Snowboard" (Product ID: 7571308511415)             â•‘');
  console.log('â•š' + 'â•'.repeat(78) + 'â•');

  try {
    // Test 1: Single option
    const product1 = await testSingleOptionProduct();
    
    // Wait
    await new Promise(r => setTimeout(r, 1000));

    // Test 2: Two options
    const product2 = await testTwoOptionProduct();
    
    // Wait
    await new Promise(r => setTimeout(r, 1000));

    // Test 3: Three options
    const product3 = await testThreeOptionProduct();

    console.log('\n\n' + 'â•'.repeat(80));
    console.log('ðŸŽ‰ ALL TESTS COMPLETED SUCCESSFULLY!');
    console.log('â•'.repeat(80) + '\n');

    console.log('SUMMARY:');
    console.log(`âœ… Test 1: Single-option product created (ID: ${product1?.id})`);
    console.log(`âœ… Test 2: Two-option product created (ID: ${product2?.id})`);
    console.log(`âœ… Test 3: Three-option product created (ID: ${product3?.id})`);

    console.log('\nðŸ“š KEY LEARNINGS:\n');
    console.log('1. Shopify AUTOMATICALLY generates options from variant option values');
    console.log('2. Do NOT send "options" in the API request - they are auto-generated');
    console.log('3. Use option1, option2, option3 fields in variants to define structure');
    console.log('4. Maximum 3 options per product (option1, option2, option3)');
    console.log('5. Each variant must have unique option value combinations');
    console.log('6. Prices can vary per variant for the same product');
    console.log('7. SKU and inventory_quantity are tracked individually per variant\n');

  } catch (error) {
    console.error('\nâŒ Test suite failed:', error.message);
    process.exit(1);
  }
}

// Execute
runAllTests().then(() => {
  process.exit(0);
}).catch((error) => {
  console.error('Fatal error:', error);
  process.exit(1);
});
