const https = require('https');
require('dotenv').config();

const SHOPIFY_STORE = 'devbaseprod.myshopify.com';
const SHOPIFY_ACCESS_TOKEN = process.env.SHOPIFY_ACCESS_TOKEN;
const SHOPIFY_API_VERSION = '2024-10';

function makeRequest(method, path, data = null) {
  return new Promise((resolve, reject) => {
    const options = {
      hostname: SHOPIFY_STORE,
      path: `/admin/api/${SHOPIFY_API_VERSION}${path}`,
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'X-Shopify-Access-Token': SHOPIFY_ACCESS_TOKEN,
        'User-Agent': 'BaseCRM/1.0',
      },
      timeout: 10000,
    };

    const req = https.request(options, (res) => {
      let responseData = '';

      res.on('data', (chunk) => {
        responseData += chunk;
      });

      res.on('end', () => {
        try {
          const parsedData = responseData ? JSON.parse(responseData) : {};
          
          if (res.statusCode >= 200 && res.statusCode < 300) {
            resolve(parsedData);
          } else {
            console.error(`\n[ERROR] Status ${res.statusCode}`);
            console.error('Response:', JSON.stringify(parsedData, null, 2));
            const error = new Error(`Shopify API Error: ${res.statusCode}`);
            error.statusCode = res.statusCode;
            error.data = parsedData;
            reject(error);
          }
        } catch (err) {
          reject(new Error(`Failed to parse response: ${err.message}`));
        }
      });
    });

    req.on('error', (error) => {
      reject(new Error(`Request failed: ${error.message}`));
    });

    req.on('timeout', () => {
      req.destroy();
      reject(new Error(`Request timeout`));
    });

    if (data) {
      req.write(JSON.stringify(data));
    }

    req.end();
  });
}

async function testCorrectTwoOption() {
  console.log('\n=== TEST: Two-Option Product (Correct) ===\n');
  console.log('Key insight: When multiple options exist, the FIRST option must change for variants');
  console.log('Example: Small-Black, Small-White, Large-Black, Large-White');
  console.log('Shopify creates variants: "Small-Black", "Small-White", etc.\n');
  
  // Correct 2-option product: option1=Color, option2=Size
  // ALL option1 values must appear with ALL option2 values
  const product = {
    product: {
      title: 'T-Shirt with Options',
      body_html: 'Available in multiple colors and sizes',
      vendor: 'Test Vendor',
      product_type: 'Apparel',
      handle: `tshirt-correct-${Date.now()}`,
      variants: [
        // Black color - all sizes
        { sku: 'TS-BLK-XS', price: '29.99', inventory_quantity: 10, option1: 'Black', option2: 'XS' },
        { sku: 'TS-BLK-SM', price: '29.99', inventory_quantity: 10, option1: 'Black', option2: 'Small' },
        { sku: 'TS-BLK-LG', price: '29.99', inventory_quantity: 10, option1: 'Black', option2: 'Large' },
        // White color - all sizes
        { sku: 'TS-WHT-XS', price: '29.99', inventory_quantity: 10, option1: 'White', option2: 'XS' },
        { sku: 'TS-WHT-SM', price: '29.99', inventory_quantity: 10, option1: 'White', option2: 'Small' },
        { sku: 'TS-WHT-LG', price: '29.99', inventory_quantity: 10, option1: 'White', option2: 'Large' },
      ]
    }
  };

  console.log('Request payload (variants only):');
  product.product.variants.forEach(v => {
    console.log(`  ${v.option1} / ${v.option2}: ${v.sku}`);
  });
  console.log('\n');

  try {
    const result = await makeRequest('POST', '/products.json', product);
    console.log('✅ SUCCESS! Product created:');
    console.log('Product ID:', result.product.id);
    console.log('Title:', result.product.title);
    console.log('Variants created:');
    result.product.variants.forEach((v, i) => {
      console.log(`  ${i+1}. ${v.title} (${v.sku}) - Price: $${v.price}`);
    });
    console.log('\nOptions auto-generated by Shopify:');
    result.product.options.forEach(opt => {
      console.log(`  ${opt.name}: [${opt.values.join(', ')}]`);
    });
  } catch (error) {
    console.error('❌ FAILED:', error.message);
  }
}

testCorrectTwoOption();
